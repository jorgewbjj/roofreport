<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEAL TOP ROOF - Inspection Report</title>
    <style>
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
        }
        .logo {
            height: 80px;
            margin-bottom: 15px;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .add-btn {
            background-color: #28a745;
            color: white;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
        }
        .submit-btn {
            background-color: #007bff;
            color: white;
            float: right;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body onload="setDefaultDate()">
    <div class="header">
        <img src="Logo%20seal%20e%20slogan@2x.png" class="logo" alt="SEAL TOP ROOF Logo">
        <h1>Roof Inspection Report</h1>
    </div>

    <div class="form-group">
        <label>Roof Condition:</label>
        <select id="roof-condition" required>
            <option value="Good">Good</option>
            <option value="Fair">Fair</option>
            <option value="Poor">Poor</option>
        </select>
    </div>

    <div class="form-group">
        <label>Property Address:</label>
        <input type="text" id="address" required>
    </div>

    <div class="form-group">
        <label>Inspector Name:</label>
        <select id="inspector" required>
            <option value="Arister Cruz">Arister Cruz</option>
            <option value="Jorge Woicikoski">Jorge Woicikoski</option>
            <option value="Pedro Ortiz">Pedro Ortiz</option>
        </select>
    </div>

    <div class="form-group">
        <label>Inspection Date:</label>
        <input type="date" id="date" required>
    </div>

    <div class="form-group">
        <label>Roof Type:</label>
        <select id="roof-type" required>
            <option value="TPO">TPO</option>
            <option value="PVC">PVC</option>
            <option value="Metal">Metal</option>
            <option value="Modified">Modified</option>
            <option value="Shingle">Shingle</option>
            <option value="Other">Other</option>
        </select>
    </div>

    <div id="observations-container">
        <div class="form-group observation-section">
            <label>Observation Description:</label>
            <textarea class="observation-desc" required></textarea>
            <label>Upload Photos for This Observation:</label>
            <input type="file" class="observation-photos" multiple accept="image/*">
            <button type="button" class="remove-btn" onclick="removeObservation(this)">Remove Observation</button>
        </div>
    </div>

    <button class="add-btn" onclick="addObservation()">Add Another Observation</button>
    <button class="submit-btn" onclick="generatePDF()">Generate Report</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        function setDefaultDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        }

        const { jsPDF } = window.jspdf;
        let observationCount = 1;

        function addObservation() {
            const container = document.getElementById('observations-container');
            const newObservation = document.createElement('div');
            newObservation.className = 'form-group observation-section';
            newObservation.innerHTML = `
                <label>Observation Description:</label>
                <textarea class="observation-desc" required></textarea>
                <label>Upload Photos for This Observation:</label>
                <input type="file" class="observation-photos" multiple accept="image/*">
                <button type="button" class="remove-btn" onclick="removeObservation(this)">Remove Observation</button>
            `;
            container.appendChild(newObservation);
            observationCount++;
        }

        function removeObservation(button) {
            if(observationCount > 1) {
                button.parentElement.remove();
                observationCount--;
            }
        }

        async function generatePDF() {
            try {
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                let yPos = 0;

                try {
                    const logo = await loadLogo();
                    const desiredWidth = 80;
                    const aspectRatio = logo.naturalHeight / logo.naturalWidth;
                    const logoHeight = desiredWidth * aspectRatio;
                    doc.addImage(logo, 'PNG', 20, 15, desiredWidth, logoHeight);
                    yPos = 15 + logoHeight + 10;
                } catch {
                    yPos = 20;
                }

                doc.setFontSize(18);
                doc.setTextColor(19, 29, 53);
                doc.text("Roof Inspection Report", pageWidth/2, yPos, { align: 'center' });
                yPos += 20;

                doc.setFontSize(12);
                doc.setTextColor(0);
                const details = [
                    `Property Address: ${document.getElementById('address').value}`,
                    `Inspector: ${document.getElementById('inspector').value}`,
                    `Inspection Date: ${document.getElementById('date').value}`,
                    `Roof Type: ${document.getElementById('roof-type').value}`,
                    `Roof Condition: ${document.getElementById('roof-condition').value}`
                ];

                details.forEach(line => {
                    if(yPos > 280) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(line, 20, yPos);
                    yPos += 10;
                });

                yPos += 15;

                const observationSections = document.getElementsByClassName('observation-section');
                for(let i = 0; i < observationSections.length; i++) {
                    const observation = observationSections[i];
                    const desc = observation.querySelector('.observation-desc').value;
                    const photos = observation.querySelector('.observation-photos').files;

                    if(yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Observation #${i+1}:`, 20, yPos);
                    yPos += 7;

                    doc.setFont('helvetica', 'normal');
                    const observationsText = doc.splitTextToSize(desc, 170);
                    observationsText.forEach(line => {
                        if(yPos > 280) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, 20, yPos);
                        yPos += 7;
                    });
                    yPos += 10;

                    for(let j = 0; j < photos.length; j++) {
                        try {
                            const imgData = await readFile(photos[j]);
                            const imgProps = doc.getImageProperties(imgData);
                            
                            const scaleFactor = 0.2;
                            let width = imgProps.width * scaleFactor;
                            let height = imgProps.height * scaleFactor;

                            const maxWidth = pageWidth - 40;
                            if(width > maxWidth) {
                                const ratio = maxWidth / width;
                                width *= ratio;
                                height *= ratio;
                            }

                            if(yPos + height > 280) {
                                doc.addPage();
                                yPos = 20;
                            }

                            doc.addImage(imgData, 'JPEG', 20, yPos, width, height);
                            yPos += height + 10;
                        } catch(error) {
                            console.error('Error processing image:', error);
                        }
                    }
                    yPos += 15;
                }

                // Generate filename with sanitized address and date
                const rawAddress = document.getElementById('address').value;
                const inspectionDate = document.getElementById('date').value;
                const sanitizedAddress = rawAddress
                    .trim()
                    .replace(/\s+/g, '_')
                    .replace(/[^a-zA-Z0-9_]/g, '');
                const fileName = `${sanitizedAddress}_${inspectionDate}.pdf`;

                doc.save(fileName);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function loadLogo() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Logo not found. Ensure file exists and is named "Logo seal e slogan@2x.png"'));
                img.src = 'Logo%20seal%20e%20slogan@2x.png';
            });
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    EXIF.getData(file, function() {
                        const orientation = EXIF.getTag(this, 'Orientation') || 1;
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            if ([5,6,7,8].includes(orientation)) {
                                canvas.width = img.height;
                                canvas.height = img.width;
                            } else {
                                canvas.width = img.width;
                                canvas.height = img.height;
                            }

                            ctx.save();
                            switch(orientation) {
                                case 2: ctx.transform(-1, 0, 0, 1, img.width, 0); break;
                                case 3: ctx.transform(-1, 0, 0, -1, img.width, img.height); break;
                                case 4: ctx.transform(1, 0, 0, -1, 0, img.height); break;
                                case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
                                case 6: ctx.transform(0, 1, -1, 0, img.height, 0); break;
                                case 7: ctx.transform(0, -1, -1, 0, img.height, img.width); break;
                                case 8: ctx.transform(0, -1, 1, 0, 0, img.width); break;
                                default: break;
                            }

                            ctx.drawImage(img, 0, 0);
                            ctx.restore();
                            resolve(canvas.toDataURL('image/jpeg'));
                        };
                        img.src = e.target.result;
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
