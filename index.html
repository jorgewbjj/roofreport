<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEAL TOP ROOF - Inspection Report</title>
    <style>
        /* ... (keep all existing styles unchanged) ... */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body onload="setDefaultDate()">
    <div class="header">
        <img src="Logo%20seal%20e%20slogan@2x.png" class="logo" alt="SEAL TOP ROOF Logo">
        <h1>Roof Inspection Report</h1>
        <p>Where quality meets the sky</p>
    </div>

    <!-- Main Form (keep all form elements unchanged) -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
        let issueCount = 1;

        // Set default date to today
        function setDefaultDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        }

        // ... (keep addIssue() and removeIssue() functions unchanged) ...

        async function generatePDF() {
            try {
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                let yPos = 0;

                try {
                    const logo = await loadLogo();
                    doc.addImage(logo, 'PNG', (pageWidth-40)/2, 15, 40, 40);
                    yPos = 70;
                } catch {
                    yPos = 20;
                    console.log('Proceeding without logo');
                }

                // Header
                doc.setFontSize(18);
                doc.setTextColor(40, 167, 69);
                doc.text("Roof Inspection Report", pageWidth/2, yPos, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text("Where quality meets the sky", pageWidth/2, yPos + 8, { align: 'center' });
                yPos += 30;

                // Property Details
                doc.setFontSize(12);
                doc.setTextColor(0);
                const details = [
                    `Property Address: ${document.getElementById('address').value}`,
                    `Inspector: ${document.getElementById('inspector').value}`,
                    `Inspection Date: ${document.getElementById('date').value}`,
                    `Roof Type: ${document.getElementById('roof-type').value}`
                ];

                details.forEach(line => {
                    if(yPos > 280) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(line, 20, yPos);
                    yPos += 10;
                });

                yPos += 15;

                // Issues Section
                const issueSections = document.getElementsByClassName('issue-section');
                for(let i = 0; i < issueSections.length; i++) {
                    const issue = issueSections[i];
                    const desc = issue.querySelector('.issue-desc').value;
                    const photos = issue.querySelector('.issue-photos').files;

                    // Issue Header
                    if(yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Issue #${i+1}:`, 20, yPos);
                    yPos += 7;

                    // Issue Description
                    doc.setFont('helvetica', 'normal');
                    const issuesText = doc.splitTextToSize(desc, 170);
                    issuesText.forEach(line => {
                        if(yPos > 280) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, 20, yPos);
                        yPos += 7;
                    });
                    yPos += 10;

                    // Photos
                    for(let j = 0; j < photos.length; j++) {
                        try {
                            const imgData = await readFile(photos[j]);
                            const imgProps = doc.getImageProperties(imgData);
                            
                            // Maintain original aspect ratio at 25% scale
                            const scale = 0.25;
                            let width = imgProps.width * scale;
                            let height = imgProps.height * scale;

                            // Check page space
                            if(yPos + height > 280) {
                                doc.addPage();
                                yPos = 20;
                            }

                            doc.addImage(imgData, 'JPEG', 20, yPos, width, height);
                            yPos += height + 10;
                        } catch(error) {
                            console.error('Error processing image:', error);
                        }
                    }
                    yPos += 15;
                }

                doc.save(`SEAL-TOP-Report-${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Image orientation correction
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    EXIF.getData(file, function() {
                        const orientation = EXIF.getTag(this, 'Orientation') || 1;
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            // Set canvas dimensions
                            if (orientation > 4) {
                                canvas.width = img.height;
                                canvas.height = img.width;
                            } else {
                                canvas.width = img.width;
                                canvas.height = img.height;
                            }

                            // Apply transformations
                            switch(orientation) {
                                case 2: ctx.transform(-1, 0, 0, 1, img.width, 0); break;
                                case 3: ctx.transform(-1, 0, 0, -1, img.width, img.height); break;
                                case 4: ctx.transform(1, 0, 0, -1, 0, img.height); break;
                                case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
                                case 6: ctx.transform(0, 1, -1, 0, img.height, 0); break;
                                case 7: ctx.transform(0, -1, -1, 0, img.height, img.width); break;
                                case 8: ctx.transform(0, -1, 1, 0, 0, img.width); break;
                            }

                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/jpeg'));
                        };
                        img.src = e.target.result;
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function loadLogo() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject();
                img.src = 'Logo%20seal%20e%20slogan@2x.png';
            });
        }
    </script>
</body>
</html>
