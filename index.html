<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SEAL TOP ROOF - Inspection Report</title>
  <style>
    :root {
      --primary-color: #007bff;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --text-color: #2c3e50;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 15px;
      color: var(--text-color);
      font-size: 16px;
    }
    .header {
      text-align: center;
      margin-bottom: 15px;
      padding: 15px 0;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .logo {
      height: 60px;
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background: white;
    }
    .top-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    button {
      padding: 14px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      flex: 1;
      min-width: 120px;
      transition: opacity 0.2s;
    }
    button:active { opacity: 0.8; }
    .add-btn { background-color: var(--success-color); color: white; }
    .remove-btn { background-color: var(--danger-color); color: white; }
    .submit-btn { background-color: var(--primary-color); color: white; }
    @media (min-width: 768px) {
      body { max-width: 800px; margin: 0 auto; padding: 20px; }
      .logo { height: 80px; }
      button { flex: none; }
      .submit-btn { float: right; }
    }
    @media (max-width: 480px) {
      .top-details { grid-template-columns: 1fr; }
      .form-group { padding: 12px; }
      button { width: 100%; }
    }
    .photo-previews img {
      max-width: 80px;
      margin: 2px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Cropper modal */
    #cropModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #cropModal .modal-content {
      background: white;
      padding: 20px;
      position: relative;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }
    #cropModal .modal-close {
      position: absolute;
      top: 10px; right: 10px;
      cursor: pointer;
      font-size: 20px;
    }
    #cropModal .modal-buttons {
      margin-top: 10px;
      text-align: center;
    }
  </style>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <!-- Firebase (Realtime Database) -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
</head>

<body>
  <!-- Report selector -->
  <div class="form-group">
    <label for="reportList">Select Report:</label>
    <select id="reportList">
      <option value="">New Report</option>
    </select>
  </div>

  <div class="header">
    <img src="Logo%20seal%20e%20slogan@2x.png" class="logo" alt="SEAL TOP ROOF Logo">
    <h1>Roof Inspection Report</h1>
  </div>

  <div class="top-details">
    <div class="form-group">
      <label>Property:</label>
      <input type="text" id="address" required>
    </div>
    <div class="form-group">
      <label>Inspector Name:</label>
      <select id="inspector" required>
        <option value="Arister Cruz">Arister Cruz</option>
        <option value="Jorge Woicikoski">Jorge Woicikoski</option>
        <option value="Pedro Ortiz">Pedro Ortiz</option>
      </select>
    </div>
    <div class="form-group">
      <label>Roof Type:</label>
      <select id="roof-type" required>
        <option value="TPO">TPO</option>
        <option value="PVC">PVC</option>
        <option value="Metal">Metal</option>
        <option value="Modified">Modified</option>
        <option value="Shingle">Shingle</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-group">
      <label>Roof Condition:</label>
      <select id="roof-condition" required>
        <option value="Good">Good</option>
        <option value="Fair">Fair</option>
        <option value="Poor">Poor</option>
      </select>
    </div>
  </div>

  <div class="form-group">
    <label>Inspection Date:</label>
    <input type="date" id="date" required>
  </div>

  <div id="observations-container"></div>

  <div class="button-group">
    <button class="add-btn" onclick="addObservation()">Add Observation</button>
    <button class="submit-btn" onclick="generatePDF()">Save &amp; Generate PDF</button>
  </div>

  <!-- Cropping Modal -->
  <div id="cropModal">
    <div class="modal-content">
      <span id="cropClose" class="modal-close">&times;</span>
      <img id="cropImage" src="" alt="Crop Image" style="max-width:100%; display:block; margin:0 auto;">
      <div class="modal-buttons">
        <button id="rotateLeft" type="button">Rotate Left</button>
        <button id="rotateRight" type="button">Rotate Right</button>
        <button id="cropConfirm" type="button">Crop</button>
      </div>
    </div>
  </div>

  <script>
    // ==== Firebase setup ====
const firebaseConfig = {
  apiKey: "AIzaSyByxwR_TWiWYMe65G9AxBFgv-_oxX9MThk",
  authDomain: "fieldreport-1c1d2.firebaseapp.com",
  projectId: "fieldreport-1c1d2",
  storageBucket: "fieldreport-1c1d2.firebasestorage.app",
  messagingSenderId: "752765269064",
  appId: "1:752765269064:web:c31c85f245e0c29ba4947d",
  measurementId: "G-18DP7CSDW9"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let loadedReportId = "";

    // ==== Form utilities ====
    function setDefaultDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
    }

    async function loadReports() {
      const snap = await db.ref('reports').once('value');
      const select = document.getElementById('reportList');
      select.querySelectorAll('option:not([value=""])').forEach(o => o.remove());
      snap.forEach(child => {
        const d = child.val();
        const opt = document.createElement('option');
        opt.value = child.key;
        opt.text = `${d.date} â€” ${d.address}`;
        select.appendChild(opt);
      });
    }

    document.getElementById('reportList').addEventListener('change', async e => {
      const id = e.target.value;
      if (!id) {
        resetForm();
        loadedReportId = "";
      } else {
        const snap = await db.ref(`reports/${id}`).once('value');
        const data = snap.val();
        loadedReportId = id;
        document.getElementById('address').value = data.address;
        document.getElementById('inspector').value = data.inspector;
        document.getElementById('roof-type').value = data.roofType;
        document.getElementById('roof-condition').value = data.roofCondition;
        document.getElementById('date').value = data.date;
        // rebuild observations
        const container = document.getElementById('observations-container');
        container.innerHTML = "";
        observationCount = 0;
        data.observations.forEach(obs => {
          addObservation();
          const sec = container.querySelectorAll('.observation-section')[observationCount - 1];
          sec.querySelector('.observation-desc').value = obs.desc;
          sec.photosDataUrls = obs.photos || [];
          // show previews
          updatePreview(sec);
        });
      }
    });

    function resetForm() {
      document.getElementById('address').value = "";
      document.getElementById('inspector').selectedIndex = 0;
      document.getElementById('roof-type').selectedIndex = 0;
      document.getElementById('roof-condition').selectedIndex = 0;
      setDefaultDate();
      const container = document.getElementById('observations-container');
      container.innerHTML = "";
      observationCount = 0;
      addObservation();
    }

    // ==== Cropping logic ====
    let currentSection, cropper;
    function attachCropListener(input) {
      input.addEventListener('change', e => {
        const sec = e.target.closest('.observation-section');
        sec.pendingFiles = Array.from(e.target.files);
        sec.photosDataUrls = [];
        e.target.value = "";
        processNextCrop(sec);
      });
    }
    function initCropping() {
      document.querySelectorAll('.observation-photos').forEach(ip => attachCropListener(ip));
    }
    function processNextCrop(sec) {
      if (!sec.pendingFiles.length) {
        closeModal();
        updatePreview(sec);
        return;
      }
      currentSection = sec;
      const file = sec.pendingFiles.shift();
      const reader = new FileReader();
      reader.onload = () => {
        cropImage.src = reader.result;
        openModal();
      };
      reader.readAsDataURL(file);
    }
    const cropModal = document.getElementById('cropModal');
    const cropImage = document.getElementById('cropImage');
    document.getElementById('cropClose').onclick = () => {
      closeModal();
      currentSection.pendingFiles = [];
      updatePreview(currentSection);
    };
    function openModal() {
      cropModal.style.display = "flex";
      cropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 1, autoCropArea: 1 });
    }
    function closeModal() {
      cropper.destroy();
      cropModal.style.display = "none";
    }
    document.getElementById('rotateLeft').onclick  = () => cropper.rotate(-90);
    document.getElementById('rotateRight').onclick = () => cropper.rotate(90);
    document.getElementById('cropConfirm').onclick = () => {
      const canvas = cropper.getCroppedCanvas({ width: 200, height: 200 });
      const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
      currentSection.photosDataUrls.push(dataUrl);
      closeModal();
      processNextCrop(currentSection);
    };
    function updatePreview(sec) {
      sec.querySelectorAll('.photo-previews').forEach(el => el.remove());
      if (sec.photosDataUrls && sec.photosDataUrls.length) {
        const preview = document.createElement('div');
        preview.className = 'photo-previews';
        sec.photosDataUrls.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          preview.appendChild(img);
        });
        sec.appendChild(preview);
      }
    }

    // ==== Observations add/remove ====
    let observationCount = 0;
    function addObservation() {
      const container = document.getElementById('observations-container');
      const div = document.createElement('div');
      div.className = 'form-group observation-section';
      div.innerHTML = `
        <label>Observation:</label>
        <textarea class="observation-desc" required></textarea>
        <label>Upload Photos for This Observation:</label>
        <input type="file" class="observation-photos" multiple accept="image/*">
        <div class="button-group">
          <button type="button" class="remove-btn" onclick="removeObservation(this)">
            Remove Observation
          </button>
        </div>
      `;
      container.appendChild(div);
      observationCount++;
      attachCropListener(div.querySelector('.observation-photos'));
    }
    function removeObservation(btn) {
      if (observationCount > 1) {
        btn.closest('.observation-section').remove();
        observationCount--;
      } else {
        alert("At least one observation is required");
      }
    }

    // ==== PDF generation & Firebase save ====
    const { jsPDF } = window.jspdf;
    async function generatePDF() {
      try {
        // gather data
        const address = document.getElementById('address').value.trim();
        const inspector = document.getElementById('inspector').value;
        const roofType = document.getElementById('roof-type').value;
        const roofCondition = document.getElementById('roof-condition').value;
        const date = document.getElementById('date').value;

        const doc = new jsPDF({ compress: true });
        const w = doc.internal.pageSize.getWidth();
        let y = 20;

        // logo (original PNG)
        try {
          const logoObj = await loadLogoRaw();
          const dw = 80;
          const dh = (logoObj.height / logoObj.width) * dw;
          doc.addImage(logoObj.element, 'PNG', (w - dw) / 2, y, dw, dh);
          y += dh + 10;
        } catch (e) {
          console.warn("Logo load failed:", e);
        }

        // title
        doc.setFontSize(18);
        doc.setTextColor(19, 29, 53);
        doc.text("Roof Inspection Report", w / 2, y, { align: 'center' });
        y += 15;

        // details
        doc.setFontSize(12);
        doc.setTextColor(0);
        const details = [
          `Property: ${address}`,
          `Inspector: ${inspector}`,
          `Date: ${date}`,
          `Roof Type: ${roofType}`,
          `Roof Condition: ${roofCondition}`
        ];
        details.forEach(line => {
          if (y > 280) { doc.addPage(); y = 20; }
          doc.text(line, 20, y);
          y += 8;
        });
        y += 8;

        // observations
        const sections = document.querySelectorAll('.observation-section');
        const savedObs = [];
        const maxW = (w - 45) * 0.5;

        sections.forEach((sec, i) => {
          const desc = sec.querySelector('.observation-desc').value.trim();
          const photos = sec.photosDataUrls || [];
          savedObs.push({ desc, photos });

          const textLines = doc.splitTextToSize(desc, w - 40);
          const textH = textLines.length * 6 + 10;
          const imgsH = Math.ceil(photos.length / 2) * (maxW + 5);

          if (y + textH + imgsH > 280) { doc.addPage(); y = 20; }

          doc.setFont('helvetica','bold');
          doc.text(`Observation #${i+1}:`, 20, y);
          y += 6;
          doc.setFont('helvetica','normal');
          textLines.forEach(line => { doc.text(line, 20, y); y += 6; });
          y += 4;

          let idx = 0;
          while (idx < photos.length) {
            if (y + maxW > 280) { doc.addPage(); y = 20; }
            doc.addImage(photos[idx], 'JPEG', 20, y, maxW, maxW);
            if (idx + 1 < photos.length) {
              doc.addImage(photos[idx+1], 'JPEG', 20 + maxW + 5, y, maxW, maxW);
            }
            idx += 2;
            y += maxW + 5;
          }
          y += 2;
        });

        const safeAddr = address.replace(/[^a-zA-Z0-9]/g, '_').substr(0,50);
        const filename = `Inspection_Report_${safeAddr}_${date}.pdf`;
        doc.save(filename);

        // save to Firebase
        const reportObj = {
          address, inspector, roofType, roofCondition, date,
          observations: savedObs,
          updatedAt: Date.now()
        };
        if (loadedReportId) {
          await db.ref(`reports/${loadedReportId}`).set(reportObj);
        } else {
          const newRef = db.ref('reports').push();
          await newRef.set(reportObj);
          loadedReportId = newRef.key;
          const o = document.createElement('option');
          o.value = loadedReportId;
          o.text = `${date} â€” ${address}`;
          document.getElementById('reportList').appendChild(o);
          document.getElementById('reportList').value = loadedReportId;
        }

        alert("Report saved and PDF generated!");
      } catch (err) {
        console.error(err);
        alert("Error: " + err.message);
      }
    }

    function loadLogoRaw() {
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res({ element: img, width: img.naturalWidth, height: img.naturalHeight });
        img.onerror = () => rej(new Error("Logo not found"));
        img.src = 'Logo%20seal%20e%20slogan@2x.png';
      });
    }

    // ==== Initialize on load ====
    window.addEventListener('DOMContentLoaded', () => {
      setDefaultDate();
      loadReports();
      initCropping();
      addObservation(); // first observation
    });
  </script>
</body>
</html>
